<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>Vagrant, Amazon EC2, Docker and Microservices pt1.</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="keywords" content="">
    <meta name="generator" content="JBake">

    <!-- Le styles -->
    <link href="../../css/bootstrap.min.css" rel="stylesheet">
    <link href="../../css/asciidoctor.css" rel="stylesheet">
    <link href="../../css/base.css" rel="stylesheet">
    <link href="../../css/prettify.css" rel="stylesheet"><link href='http://fonts.googleapis.com/css?family=Lato:300,400' rel='stylesheet' type='text/css'><link href='http://fonts.googleapis.com/css?family=Abel' rel='stylesheet' type='text/css'>
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <!--<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">-->
    <link rel="shortcut icon" href="../../favicon.ico">
  </head>
  <body onload="prettyPrint()">
    <div id="wrap">
	
	<!-- Fixed navbar -->
    <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../../">Sion's Blog</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="../../index.html">Home</a></li>
            <li><a href="../../about.html">About</a></li>
            <li><a href="../../feed.xml">Subscribe</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </div>
    <div class="container">
	
	<div class="page-header">
		<h1>Vagrant, Amazon EC2, Docker and Microservices pt1.</h1>
	</div>

	<p><em>09 March 2015</em></p>
	<p><em>Tags: </em>
		<a href="/blog/tags/vagrant.html">vagrant</a>
	</em>
		<a href="/blog/tags/ec2.html"> ec2</a>
	</em>
		<a href="/blog/tags/aws.html"> aws</a>
	</em>
		<a href="/blog/tags/docker.html"> docker</a>
	</em>
		<a href="/blog/tags/microservice.html"> microservice</a>
	</em>
		<a href="/blog/tags/gradle.html"> gradle</a>
	</p>

	<p><div class="sect1">
<h2 id="_introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Microservices are all the rage at the moment, but from my experience they just move the bottleneck. Yes, the speed of development increases massively, but it does so at the cost of an increased dependency on the Build and Ops guys.</p>
</div>
<div class="paragraph">
<p>This blog series is about using Docker to run a complete and fully functional microservice in the cloud using Vagrant, Amazon AWS and Docker. The goals are as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Provisioning of the EC2 instance should be automated</p>
</li>
<li>
<p>The microservices should run in their own containers</p>
</li>
<li>
<p>The setup and configuration of the containers should be fully automated, no manual steps required</p>
</li>
<li>
<p>Capture everything in a GitHub project.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_vagrant">Vagrant</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Vagrant is a nice way to manage our EC2 instances. We can use Vagrant to create and instance and provision the box to a state we desire.</p>
</div>
<div class="paragraph">
<p>Once Vagrant is installed on your dev machine, to use the <code>AWS</code> provider type in Vagrant we will need to install the Vagrant AWS plugin. That can be done with the following command:</p>
</div>
<div class="paragraph">
<p><code>vagrant plugin install vagrant-aws</code></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
This took a while on my machine without a great deal of feedback. Just be patient, it will finish eventually.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>So, now lets create our project and the Vagrantfile. Run the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint bash language-bash"><code># create a project folder
$ mkdir infra-n-app-automation

# change directory
$ cd infra-n-app-automation

# create the vagrant file
$ vagrant init</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should get a message something similar to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code>A `Vagrantfile` has been placed in this directory. You are now
ready to `vagrant up` your first virtual environment! Please read
the comments in the Vagrantfile as well as documentation on
`vagrantup.com` for more information on using Vagrant.</code></pre>
</div>
</div>
<div class="paragraph">
<p>If we follow the Vagrant AWS plugin docs, we can see the basic Vagrantfile should look as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint ruby language-ruby"><code>Vagrant.configure("2") do |config|
  config.vm.box = "dummy"

  config.vm.provider :aws do |aws, override|
    aws.access_key_id = "YOUR KEY"
    aws.secret_access_key = "YOUR SECRET KEY"
    aws.session_token = "SESSION TOKEN"
    aws.keypair_name = "KEYPAIR NAME"

    aws.ami = "ami-7747d01e"

    override.ssh.username = "ubuntu"
    override.ssh.private_key_path = "PATH TO YOUR PRIVATE KEY"
  end
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>The guide suggests putting your <code>access_key_id</code> and <code>secret_access_key</code> in the Vagrantfile, which is fine if you have a private repository, but as I plan on making this public I will set them using environment variables.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint bash language-bash"><code>export AWS_ACCESS_KEY="AKXXXXXXXXXXXXXXX"
export AWS_SECRET_KEY="XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"</code></pre>
</div>
</div>
<div class="paragraph">
<p>After configuring my Security Group, selecting an AMI and sorting my private key, my Vagrantfile now looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint ruby language-ruby"><code># -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.configure(2) do |config|
  # Box configuration
  config.vm.box = "dummy"
  config.vm.box_url = "https://github.com/mitchellh/vagrant-aws/raw/master/dummy.box"

  # Share an additional folder to the guest VM.
  # config.vm.synced_folder "../data", "/vagrant_data"

  # Provider
  config.vm.provider :aws do |aws, override|
    aws.keypair_name = "dev"
    override.ssh.username = "ubuntu"
    override.ssh.private_key_path = "~/.ssh/dev.pem"

    aws.ami = "ami-234ecc54" #Ubuntu 12.04 LTS
    aws.region = "eu-west-1"
    aws.instance_type = "t2.micro"
    aws.security_groups = ["WebServerSG"]

    aws.tags = {
      'Name' =&gt; 'Vagrant'
    }
  end

  # Provisioning
end</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_gotchas">Gotchas</h3>
<div class="paragraph">
<p>I had a few challenges when I first started with Vagrant and AWS. They were:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Security Groups</strong> - You will noticed I used the <code>WebServerSG</code> group. I set this up as per the Amazon documentation found <a href="http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/VPC_Scenario3.html#SecurityGroups-3">here</a>. Until I made this change I was hanging at the "<em>Waiting for SSH to become available&#8230;</em>" stage.</p>
</li>
<li>
<p><strong>AMI</strong> - If you want to use the free tier I would recommend going through the Amazon "Launch Instance" wizard and recording the AMI id for your region and price plan. I found some of the online examples simply didn&#8217;t exist and were region specific.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This concludes part one of the tutorial. We can now create and control the lifecycle of an EC2 instance, and in part two we will install Docker and any other dependencies on the instance.</p>
</div>
<div class="paragraph">
<p>The source can be found in the repository below:
<a href="https://github.com/willis7/infra-n-app-automation">https://github.com/willis7/infra-n-app-automation</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_update_strong_edited_10_03_2015_strong">Update! <strong>Edited: 10-03-2015</strong></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Be very careful with your Amazon details on the web. I have provided a solution above for removing them from your source code. For a more in depth example see, <a href="http://www.devopsdiary.com/blog/2013/05/07/automated-deployment-of-aws-ec2-instances-with-vagrant-and-puppet/">here</a>.Dont end up like this poor fella: <a href="https://securosis.com/S=0/blog/my-500-cloud-security-screwup">My $500 Cloud Security Screwup</a></p>
</div>
</div>
</div></p>

	<!-- **** DISQUS **** -->
	<div id="disqus_thread"></div>
	<script type="text/javascript">
		/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
		var disqus_shortname = 'willis7'; // required: replace example with your forum shortname

		/* * * DON'T EDIT BELOW THIS LINE * * */
		(function() {
			var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
			dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
			(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
		})();
	</script>
	<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
	<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
	<!-- **** END **** -->

	<hr>
	
		</div>
		<div id="push"></div>
    </div>
    
    <div id="footer">
      <div class="container">
        <p class="muted credit">&copy; 2014 | Mixed with <a href="http://getbootstrap.com/">Bootstrap v3.1.1</a> | Baked with <a href="http://jbake.org">JBake v2.3.0</a></p>
      </div>
    </div>
    
    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="../../js/jquery-1.11.1.min.js"></script>
    <script src="../../js/bootstrap.min.js"></script>
    <script src="../../js/prettify.js"></script>

    <!-- **** DISQUS **** -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'willis7'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script'); s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- **** END **** -->
    
  </body>
</html>
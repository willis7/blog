<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>Vagrant, Amazon EC2, Docker and Microservices pt4.</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="My tech blog and mumbles">
    <meta name="author" content="Sion Williams">
    <meta name="keywords" content="devops,automation,ci,cd,gradle,groovy">
    <meta name="generator" content="JBake">

    <!-- Le styles -->
    <link href="../../css/bootstrap.min.css" rel="stylesheet">
    <link href="../../css/asciidoctor.css" rel="stylesheet">
    <link href="../../css/base.css" rel="stylesheet">
    <link href="../../css/prettify.css" rel="stylesheet">
    <link href='http://fonts.googleapis.com/css?family=Lato:300,400' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Abel' rel='stylesheet' type='text/css'>
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <!--<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">-->
    <link rel="shortcut icon" href="../../favicon.ico">
  </head>
  <body onload="prettyPrint()">
    <div id="wrap">

	<!-- Fixed navbar -->
    <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../../">Sion's Blog</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="../../index.html">Home</a></li>
            <li><a href="../../about.html">About</a></li>
            <li><a href="../../feed.xml">Subscribe</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </div>
    <div class="container">

	<div class="page-header">
		<h1>Vagrant, Amazon EC2, Docker and Microservices pt4.</h1>
	</div>

	<p><em>17 March 2015</em></p>
	<p><em>Tags: </em>
		<a href="/blog/tags/vagrant.html">vagrant</a>
	</em>
		<a href="/blog/tags/ec2.html"> ec2</a>
	</em>
		<a href="/blog/tags/aws.html"> aws</a>
	</em>
		<a href="/blog/tags/docker.html"> docker</a>
	</em>
		<a href="/blog/tags/microservice.html"> microservice</a>
	</em>
		<a href="/blog/tags/gradle.html"> gradle</a>
	</em>
		<a href="/blog/tags/ansible.html"> ansible</a>
	</em>
		<a href="/blog/tags/spring.html"> spring</a>
	</p>

	<p><div class="sect1">
<h2 id="_the_microservice">The Microservice</h2>
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="http://2.bp.blogspot.com/-qHSsmfROS1c/UoFWwtez3iI/AAAAAAAAG0M/nxKwNEOaRSs/s1600/logo-spring-io.png" alt="spring logo">
</div>
</div>
<div class="paragraph">
<p>For this tutorial I&#8217;m going to use a spring boot application that will help us prove the concepts behind this tutorial. There are loads of microservice frameworks to chose from, but for this tutorial we will use Spring Boot. Maybe in the future I will look at trying out some other popular frameworks. Links to the Spring guide are given at the bottom of this tutorial.</p>
</div>
<div class="paragraph">
<p>At this point we could cheat and do everything in Gradle. Here&#8217;s a <a href="http://thediscoblog.com/blog/2014/06/13/docker-containers-with-gradle-in-4-steps/">handy tutorial</a> showing how to perform your build and docker run using Gradle.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_docker">Docker</h2>
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="http://blog.docker.com/wp-content/uploads/2013/08/KuDr42X_ITXghJhSInDZekNEF0jLt3NeVxtRye3tqco.png" alt="docker logo">
</div>
</div>
<div class="paragraph">
<p>When I first started writing this article I had plans of going through a 101 for Docker. Since then I have found a fantastic youtube video called <a href="https://www.youtube.com/watch?v=4W2YY-qBla0&amp;index=21&amp;list=PLDF29927F90450C06">Docker 101: Dockerizing Your Infrastructure</a> and I just don&#8217;t think I can add anything to that excellent tutorial. So, rather than going from the foundations I have decided to assume you have watched that video.</p>
</div>
<div class="paragraph">
<p>Now that we can do the basics with Docker lets start setting our requirements for the container. First, we need java installed so that we can start our microservice. Then, it would be good if we could do some monitoring once the service is started. This is especially important if we plan on running this in a production setting. For that reason we&#8217;re going to move away from ubuntu images, and use an extended version of the <a href="https://phusion.github.io/baseimage-docker/">baseimage</a> image by Phusion. The image is called <a href="https://registry.hub.docker.com/u/flurdy/oracle-java7/">flurdy/oracle-java7</a> and if we look at the Dockerfile for <code>flurdy/oracle-java7</code> we can see this image is using <code>phusion/baseimage:latest</code> and bootstrapping it with Java.</p>
</div>
<div class="paragraph">
<p>Lets start building our <code>Dockerfile</code>. I have created mine in <code>${projectDir}/app/docker</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>FROM flurdy/oracle-java7:latest
MAINTAINER willis7
EXPOSE 8080
ADD build/libs/gs-spring-boot-0.1.0.jar /opt/msvc/gs-spring-boot.jar
CMD java -jar /opt/msvc/gs-spring-boot.jar</pre>
</div>
</div>
<div class="paragraph">
<p>With the FROM keyword Docker will first look for the image locally, then look to the public repo if it doesn&#8217;t find it.</p>
</div>
<div class="paragraph">
<p>MAINTAINER simply tells the reader who the author of this Dockerfile is.</p>
</div>
<div class="paragraph">
<p>EXPOSE tells Docker that a port is to be exposed when the container is started. Now, lets add our build output to the container; we do that using the ADD keyword:</p>
</div>
<div class="paragraph">
<p>The ADD instruction basically takes a &lt;src&gt; and &lt;dest&gt;. If the &lt;dest&gt; path doesn&#8217;t exist, it is created along with the missing directories along its path.</p>
</div>
<div class="paragraph">
<p>Finally, we need to tell Docker what command should be run when the container is executed. We do that with the CMD keyword.</p>
</div>
<div class="paragraph">
<p>And thats it!</p>
</div>
<div class="paragraph">
<p>If you look in my github repository you will find 2 helper scripts - one to build the image and the second to run it.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>docker-build.sh
docker-run.sh</pre>
</div>
</div>
<div class="paragraph">
<p>Lets run through the steps:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint bash language-bash"><code># Build the source code and run unit tests
$ cd app
$ .gradlew clean build

# Create and provision a VM
$ cd ..
$ vagrant up

# ssh into the box
$ vagrant ssh

# cd to the docker scripts
$ cd /vagrant/docker/

# docker build
$ . docker-build.sh

# docker run
$ . docker-run.sh

# test service running
$ curl localhost:8080
Greetings from Spring Boot!</code></pre>
</div>
</div>
<div class="paragraph">
<p>At this point we could get Ansible to do all of these steps, but as this is a learning exercise its nice to go through the motions. If you were to add these steps, then we refactored earlier, so these would sit nicely in the Docker Playbook.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This tutorial series has been a whistle stop tour through a few different tools and technologies. Whilst the example was extremely simple, hopefully you can see how this could be applied to a Continuous Delivery pipeline for on demand test environments. For the small effort up front in writing your scripts (which in this case were super simple!), you can save costs from not having "always on" environments that aren&#8217;t being used. Also, because we provisioned the environments using a coded format, we can rest assured the environments are the same every time - we also get the luxury of being able to version control our scripts as a result.</p>
</div>
<div class="paragraph">
<p>If you have any questions or would like me to clarify anything in these tutorials then please feel free to add a comment below.</p>
</div>
<div class="paragraph">
<p>Resources:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://spring.io/guides/gs/spring-boot/">Building an Application with Spring Boot</a></p>
</li>
<li>
<p><a href="http://plainoldobjects.com/2014/11/16/deploying-spring-boot-based-microservices-with-docker/">Deploying Spring Boot-based microservices with Docker</a></p>
</li>
</ul>
</div>
</div>
</div></p>

	<hr>

	<!-- **** DISQUS **** -->
	<div id="disqus_thread"></div>
	<script type="text/javascript">
		/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
		var disqus_shortname = 'willis7'; // required: replace example with your forum shortname
		var disqus_identifier = '2015/03/vagrant-aws-docker-gradle-pt4.html';
    	var disqus_title = "Vagrant, Amazon EC2, Docker and Microservices pt4.";
    	var disqus_url = 'https://willis7.github.io/blog2015/03/vagrant-aws-docker-gradle-pt4.html';

		/* * * DON'T EDIT BELOW THIS LINE * * */
		(function() {
			var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
			dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
			(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
		})();
	</script>
	<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
	<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
	<!-- **** END **** -->

	<!-- **** ANALYTICS **** -->
	<script>
	  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	  ga('create', 'UA-60966243-1', 'auto');
	  ga('send', 'pageview');

	</script>
	<!-- **** END **** -->

		</div>
		<div id="push"></div>
    </div>
    
    <div id="footer">
      <div class="container">
        <p class="muted credit">&copy; 2014 | Mixed with <a href="http://getbootstrap.com/">Bootstrap v3.1.1</a> | Baked with <a href="http://jbake.org">JBake v2.3.0</a></p>
      </div>
    </div>
    
    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="../../js/jquery-1.11.1.min.js"></script>
    <script src="../../js/bootstrap.min.js"></script>
    <script src="../../js/prettify.js"></script>

    <!-- **** DISQUS **** -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'willis7'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script'); s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- **** END **** -->
    
  </body>
</html>